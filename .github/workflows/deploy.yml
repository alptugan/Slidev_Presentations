name: Deploy Multiple Slidev Projects

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  #
  # JOB 1: Build all projects in parallel
  #
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project_path:
          - '2025-2026/week07_cod_207-Image-Processing'
          # - '2025-2026/week06_cod_207-Media'
          # - '2025-2026/week05_cod_207-Randomness-Repetetion'
          # Add your other 3 project folders here...
          # - '2025-2026/your-other-project-1'
          # - '2025-2026/your-other-project-2'
          # - '2025-2026/your-other-project-3'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Slidev CLI
        run: npm install -g @slidev/cli

      #
      # === THIS IS THE NEW, CORRECTED BUILD STEP ===
      #
      - name: Build Project (${{ matrix.project_path }})
        run: |
          set -euo pipefail # Fail the script if any command fails
          echo "Building project: ${{ matrix.project_path }}"

          # 1. Move into the project directory. This is the main fix.
          # Asset paths like 'image.png' will now resolve correctly.
          cd "${{ matrix.project_path }}"

          # 2. Sanity check: make sure slides.md exists
          if [ ! -f slides.md ]; then
            echo "ERROR: slides.md not found in $(pwd)"
            ls -la || true
            exit 1
          fi

          # 3. Debug: check for any remaining bad asset paths (with leading slashes)
          echo "Checking for leading-slash asset paths in slides.md..."
          grep -nE '(^|\s)(src:|image:|background:|favicon:|!?\[).*["'\'']?\/' slides.md || true

          # 4. Create the output directory relative to the *repo root*
          # (../../ moves up from '.../week07' to '2025-2026' and then to root)
          mkdir -p "../../dist/${{ matrix.project_path }}"

          # 5. Run the build from *inside* the project folder
          slidev build slides.md \
            --base "/Slidev_Presentations/${{ matrix.project_path }}/" \
            --out "../../dist/${{ matrix.project_path }}"

          echo "Built files for ${{ matrix.project_path }}:"
          ls -R "../../dist/${{ matrix.project_path }}" || true

      # 6. Upload the artifact. The 'dist' folder is at the repo root.
      - name: Upload partial build artifact
        uses: actions/upload-artifact@v4
        with:
          name: partial-dist-${{ hashFiles(matrix.project_path) }}
          path: ./dist # This path is correct, as the build step outputs to the root 'dist'
          retention-days: 1

  #
  # JOB 2: Package all partial builds (No changes needed)
  #
  package:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all partial build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: partial-dist-*
          path: ./dist
          merge-multiple: true

      - name: (Debug) List packaged files
        run: ls -R ./dist

      - name: Upload final 'github-pages' artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ./dist
          retention-days: 1

  #
  # JOB 3: Deploy the final artifact (No changes needed)
  #
  deploy:
    needs: package
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4