name: Deploy Multiple Slidev Projects

# Run on pushes to your main branch
on:
  push:
    branches:
      - main

# Set permissions for the workflow
permissions:
  contents: read
  pages: write      # Required to deploy to GitHub Pages
  id-token: write   # Required for OIDC token authentication

jobs:
  #
  # JOB 1: Build all projects in parallel
  #
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        #
        # === IMPORTANT ===
        # Add all your project paths here.
        #
        project_path:
          - '2025-2026/week07_cod_207-Image-Processing'
          #- '2025-2026/week06_cod_207-Media'
          #- '2025-2026/week05_cod_207-Randomness-Repetetion'
          # Add your other project folders here...

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Slidev CLI
        run: npm install -g @slidev/cli

      - name: Build Project (${{ matrix.project_path }})
        run: |
          set -euo pipefail
          echo "Building project: ${{ matrix.project_path }}"

          # sanity check: slides.md exists
          if [ ! -f "${{ matrix.project_path }}/slides.md" ]; then
            echo "ERROR: slides.md not found at ${{ matrix.project_path }}/slides.md"
            echo "Listing project dir for debugging:"
            ls -la "${{ matrix.project_path }}" || true
            exit 1
          fi

          # ensure top-level dist exists
          mkdir -p dist

          # create a safe output directory (preserve path under dist)
          OUT_DIR="dist/${{ matrix.project_path }}"
          mkdir -p "$OUT_DIR"

          # run slidev build into the per-project output folder
          slidev build "${{ matrix.project_path }}/slides.md" \
            --base "/Slidev_Presentations/${{ matrix.project_path }}/" \
            --out "$OUT_DIR"

          # list results for debugging
          echo "Built files for ${{ matrix.project_path }}:"
          ls -la "$OUT_DIR" || true
          ls -R "$OUT_DIR" || true

      - name: Set artifact name
        id: artifact
        run: |
          # sanitize matrix path into a safe artifact name (replace / with _ and remove unsafe chars)
          safe_name=$(echo "${{ matrix.project_path }}" | tr '/' '_' | tr -c '[:alnum:]_-' '_')
          echo "artifact_name=partial-dist-${safe_name}" >> $GITHUB_OUTPUT

      - name: Upload partial build artifact
        uses: actions/upload-artifact@v4
        with:
          # safe deterministic artifact name without slashes
          name: ${{ steps.artifact.outputs.artifact_name }}
          # upload only the built subfolder to avoid ambiguity
          path: "dist/${{ matrix.project_path }}"
          retention-days: 1

  #
  # JOB 2: Package all partial builds into one artifact
  #
  package:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all partial build artifacts
        uses: actions/download-artifact@v4
        with:
          # Download all artifacts that start with 'partial-dist-'
          pattern: partial-dist-*
          # Merge them all into a single 'dist' directory
          path: ./dist
          merge-multiple: true

      - name: List files for debugging (optional)
        run: |
          echo "Listing ./dist after download:"
          ls -la ./dist || true
          ls -R ./dist || true

      - name: Fail if dist is empty
        run: |
          if [ ! -d "./dist" ] || [ -z "$(ls -A ./dist 2>/dev/null || true)" ]; then
            echo "ERROR: ./dist is empty after downloading artifacts. No partial artifacts were found."
            echo "Possible causes:"
            echo " - Build jobs failed before uploading artifacts."
            echo " - Artifact names differ from the expected pattern 'partial-dist-*'."
            echo " - Transient network or Actions service errors prevented uploads/downloads."
            echo ""
            echo "Check build job logs to confirm 'Upload artifact' entries and re-run."
            exit 1
          fi

      - name: Upload final 'github-pages' artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: ./dist
          retention-days: 1

  #
  # JOB 3: Deploy the final packaged artifact
  #
  deploy:
    needs: package

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # This action automatically finds the 'github-pages' artifact
        # uploaded by the 'package' job.