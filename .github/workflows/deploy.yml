name: Deploy pages

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits for git diff

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Download previous build artifacts
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: deploy.yml
          name: github-pages
          path: previous-dist

      - name: Extract previous builds
        continue-on-error: true
        run: |
          if [ -f previous-dist/artifact.tar ]; then
            echo "Extracting previous build artifacts..."
            mkdir -p dist
            tar -xf previous-dist/artifact.tar -C dist
            echo "Previous builds extracted to dist/"
            ls -la dist/
          else
            echo "No previous artifacts found, starting fresh"
            mkdir -p dist
          fi

      - name: Find all Slidev projects
        id: find-projects
        run: |
          # Define directories to search for Slidev projects
          SEARCH_DIRS="2025-2026 Workshops"

          echo "Searching for Slidev projects in: $SEARCH_DIRS"
          ALL_PROJECTS=""

          for dir in $SEARCH_DIRS; do
            if [ -d "$dir" ]; then
              echo "Searching in $dir..."
              FOUND=$(find "$dir" -mindepth 1 -maxdepth 1 -type d -exec test -f '{}/slides.md' ';' -print | tr '\n' ' ')
              ALL_PROJECTS="$ALL_PROJECTS $FOUND"
            fi
          done

          echo "all_projects=$ALL_PROJECTS" >> $GITHUB_OUTPUT
          echo "All Slidev projects found: $ALL_PROJECTS"

      - name: Detect changed projects
        id: changed
        run: |
          OUTPUT_ROOT=dist
          mkdir -p "$OUTPUT_ROOT"

          ALL_PROJECTS="${{ steps.find-projects.outputs.all_projects }}"

          # Get list of changed files in the last commit
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For manual runs, build all projects
            echo "Manual trigger - building all projects"
            CHANGED_PROJECTS="$ALL_PROJECTS"
          else
            # Get changed files from the push
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "Changed files:"
            echo "$CHANGED_FILES"

            # Extract unique project folders that were changed
            CHANGED_PROJECTS=""
            for project in $ALL_PROJECTS; do
              # Check if any file in this project folder was changed
              if echo "$CHANGED_FILES" | grep -q "^$project/"; then
                echo "Project $project has changes"
                CHANGED_PROJECTS="$CHANGED_PROJECTS $project"
              fi
            done

            # If no changed projects detected, check for new projects
            if [ -z "$CHANGED_PROJECTS" ]; then
              echo "No specific projects changed, checking for new projects..."
              for project in $ALL_PROJECTS; do
                if [ ! -d "$OUTPUT_ROOT/$project" ]; then
                  echo "New project detected: $project"
                  CHANGED_PROJECTS="$CHANGED_PROJECTS $project"
                fi
              done
            fi
          fi

          echo "Projects to build: $CHANGED_PROJECTS"
          echo "projects=$CHANGED_PROJECTS" >> $GITHUB_OUTPUT

      - name: Pre-build folder listing
        run: |
          echo "------ All Slidev projects found ------"
          echo "${{ steps.find-projects.outputs.all_projects }}"
          echo "------ Projects to build this run ------"
          echo "${{ steps.changed.outputs.projects }}"
          echo "------ Existing builds in dist/ ------"
          find dist -mindepth 1 -maxdepth 2 -type d 2>/dev/null || echo "No existing builds"

      - name: Build changed Slidev projects
        run: |
          set -euxo pipefail
          OUTPUT_ROOT=dist
          mkdir -p "$OUTPUT_ROOT"
          ERROR=0
          BUILT_COUNT=0

          PROJECTS_TO_BUILD="${{ steps.changed.outputs.projects }}"

          if [ -z "$PROJECTS_TO_BUILD" ]; then
            echo "No projects need to be built"
            echo "::notice::No changes detected in Slidev projects, deploying existing builds"
          else
            for folder in $PROJECTS_TO_BUILD; do
              if [ -d "$folder" ] && [ -f "$folder/slides.md" ]; then
                echo "============ Processing: $folder ============"
                if [ ! -f "$folder/package.json" ]; then
                  echo "::error:: $folder is missing package.json"
                  ERROR=1
                  continue
                fi
                if [ ! -f "$folder/pnpm-lock.yaml" ]; then
                  echo "::error:: $folder is missing pnpm-lock.yaml"
                  ERROR=1
                  continue
                fi

                # Remove old build if exists
                if [ -d "$OUTPUT_ROOT/$folder" ]; then
                  echo "Removing old build for $folder"
                  rm -rf "$OUTPUT_ROOT/$folder"
                fi

                echo "--> Installing dependencies in $folder..."
                ls -l "$folder"
                cd "$folder"
                pnpm install --frozen-lockfile || { echo "::error:: pnpm install failed in $folder"; ERROR=1; cd -; continue; }
                echo "--> Dependencies installed in $folder"
                echo "--> Building Slidev presentation in $folder"
                pnpm exec slidev build --base "/${{ github.event.repository.name }}/$folder/" --out "../../$OUTPUT_ROOT/$folder" --wait-until "none" || { echo "::error:: Slidev build failed in $folder"; ERROR=1; cd -; continue; }
                cd -
                echo "--> Build complete for $folder. Listing output:"
                if [ -d "$OUTPUT_ROOT/$folder" ]; then
                  ls -lhR "$OUTPUT_ROOT/$folder"
                  BUILT_COUNT=$((BUILT_COUNT + 1))
                else
                  echo "::error:: Expected output folder $OUTPUT_ROOT/$folder not found"
                  ERROR=1
                  continue
                fi
                if [ ! -f "$OUTPUT_ROOT/$folder/index.html" ]; then
                  echo "::error:: No index.html produced in $OUTPUT_ROOT/$folder!"
                  ERROR=1
                  continue
                fi
              fi
            done
            echo "::notice::Built $BUILT_COUNT project(s) this run"
          fi

          echo "------ Final dist structure ------"
          find "$OUTPUT_ROOT" || echo "$OUTPUT_ROOT not found!"

          # Final fail if any project errored
          if [ "$ERROR" -ne 0 ]; then
            echo "::error:: One or more projects failed to build, check the log above."
            exit 1
          fi

          # Ensure at least one index.html exists in total
          if ! find "$OUTPUT_ROOT" -type f -name index.html | grep .; then
            echo "::error:: No index.html files found in $OUTPUT_ROOT"
            exit 1
          fi

      - name: Copy root static files
        run: |
          echo "Copying root-level static files to dist..."
          # Copy the main landing page files
          cp -v index.html dist/ || echo "No index.html in root"
          cp -v *.html dist/ 2>/dev/null || echo "No additional HTML files in root"

          # Copy assets and images directories
          if [ -d "assets" ]; then
            cp -rv assets dist/
            echo "Copied assets/ directory"
          fi

          if [ -d "images" ]; then
            cp -rv images dist/
            echo "Copied images/ directory"
          fi

          echo "Root static files copied successfully"
          ls -la dist/

      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4