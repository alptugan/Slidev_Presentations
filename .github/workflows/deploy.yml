name: Deploy Slidev Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Playwright browsers once for all builds
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build All Slidev Projects
        run: |
          set -euo pipefail
          OUT_DIR="dist"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          # Find all directories under '2025-2026' that have a slides.md
          PROJECT_DIRS=$(find 2025-2026 -maxdepth 2 -type f -name 'slides.md' -printf '%h\n')

          if [ -z "$PROJECT_DIRS" ]; then
            echo "No projects with slides.md found. Exiting."
            exit 0
          fi

          echo "Found projects in:"
          echo "$PROJECT_DIRS"

          # Loop through each project directory
          for p in $PROJECT_DIRS; do
            echo "--- Building project in: $p ---"

            # --- This is the new, robust local install part ---
            # Create a package.json if it doesn't exist, defining all deps
            if [ ! -f "$p/package.json" ]; then
              echo "Creating package.json for $p"
              cat <<EOF > "$p/package.json"
          {
            "name": "slidev-presentation-$(basename $p)",
            "private": true,
            "scripts": {
              "build": "slidev build --base /${REPO_NAME}/${p}/"
            },
            "dependencies": {
              "@slidev/cli": "^0.48.0",
              "@slidev/theme-default": "*",
              "@slidev/theme-seriph": "*",
              "@iconify-json/logos": "*",
              "playwright-chromium": "*"
            }
          }
          EOF
            fi

            # Install local dependencies
            (cd "$p" && npm install)

            # Run the build using the local installation
            # The output path is relative to the project dir, so we adjust
            (cd "$p" && npm run build -- --out "../../$OUT_DIR/$p")

            echo "--- Finished building $p ---"
          done

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4